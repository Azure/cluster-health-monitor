# This runs a dnsmasq server that resolves all DNS queries to 1.2.3.4.
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: mock-localdns
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: mock-localdns
  template:
    metadata:
      labels:
        app: mock-localdns
    spec:
      hostNetwork: true
      containers:
        - name: dnsmasq
          image: jpillora/dnsmasq
          args:
            # Options doc: https://dnsmasq.org/docs/dnsmasq-man.html.
            - "--address=/kubernetes.default.svc.cluster.local/1.2.3.4"
            - "--address=/mcr.microsoft.com/4.3.2.1"
            - "--address=/#/"
            - "--log-queries"
            - "--log-facility=-"
---
# This runs a container that binds LocalDNS IP address to the node's network interface.
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: bind-localdns-ip
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: bind-localdns-ip
  template:
    metadata:
      labels:
        app: bind-localdns-ip
    spec:
      hostNetwork: true
      containers:
        - name: ip-binder
          image: busybox
          command: ["/bin/sh", "-c"]
          args:
            - |
              ip addr add 169.254.10.11/32 dev eth0
              sleep infinity
          lifecycle:
            preStop:
              exec:
                command:
                  ["/bin/sh", "-c", "ip addr del 169.254.10.11/32 dev eth0"]
          securityContext:
            capabilities:
              add: ["NET_ADMIN"]
